# 競品監測系統重設計：建庫 → 匹配 → 監測

> 日期：2026-02-13
> 狀態：設計完成（含 DA 審查修訂），實施中

## 背景

現有競品匹配是「以我的商品為中心，逐個去對手平台搜索」的模式。
這個模式有三個根本問題：

1. **覆蓋率低** — 每次只搜 3-5 個候選，完全沒有全局視野
2. **平台差異被硬塞進 if/else** — HKTVmall 有即時搜索 API，惠康要先爬後配，兩個完全不同的工作流被強行統一
3. **無法支撐數據分析** — 不知道對手有多少同類商品、價格帶分布、品類空白在哪

## 設計目標

從「逐個找對手」轉變為「先建立完整競品庫，再做系統性比對」：

```
舊模式：我的商品 → 搜索對手 → 找到候選 → AI 判斷 → 存配對
新模式：
  階段一：建庫 — 把對手的肉類/海鮮全部爬下來
  階段二：匹配 — 我的商品 × 競品庫，AI 批量比對，標記三層關係
  階段三：監測 — 每日更新全庫，追蹤價格變動、新品上架、商品下架
```

## 核心架構

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Cataloger  │────→│   Matcher   │────→│   Monitor   │
│  競品建庫    │     │   智能匹配   │     │   每日監測   │
└─────────────┘     └─────────────┘     └─────────────┘
   職責：爬取          職責：比對          職責：追蹤
   對手分類商品        標記三層關係        發現變化異動
```

三個模塊職責完全分離：
- **Cataloger** 只管「對手有什麼」— 不管跟我有沒有關係
- **Matcher** 只管「跟我什麼關係」— 直接替代品 / 近似競品 / 品類競品
- **Monitor** 只管「有什麼變化」— 價格漲跌、新品上架、商品下架

---

## 一、Cataloger（競品建庫）

### 競品範圍

聚焦 GoGoJap 核心品類：**肉類 + 海鮮**。

**實際數據（Algolia 統計 2026-02-13）：**
- HKTVmall 肉類/海鮮相關搜索結果數以萬計，但包含大量噪音（調味料、零食等）
- 聚焦切割詞：和牛 695、西冷 245、牛柳 141、牛仔骨 243、刺身 1,845
- **實際真正的肉類/海鮮競品估計：1,000 - 3,000 個**（非最初假設的「幾百個」）
- 惠康範圍較小：肉類 + 海鮮估計 100-300 個
- 兩個平台合計：**~1,500 - 3,000 個競品商品**

### 爬取策略（按平台）

```
HKTVmall:
  Algolia API → 按分類批量拉取 → 幾百個商品
  速度快（~200ms/頁），已有現成 connector

惠康:
  Playwright 瀏覽分類頁 → 提取產品 URL → HTTP GET JSON-LD
  需要 JS 渲染（~30s/頁），但分類頁就幾頁
  惠康搜索頁返回 HTTP 500，無法使用搜索功能
```

### 混合標籤系統（規則引擎 + AI 兜底）

> DA 審查修訂：原設計全用 AI 打標，但實際商品量 1,500-3,000 個，
> 全 AI 打標成本 $3-8。改用規則引擎處理 80%，AI 只處理長尾 20%。

```
標籤體系：
  肉類 → 牛 / 豬 / 羊 / 雞鴨
  牛   → 西冷 / 肉眼 / 牛柳 / 牛仔骨 / 牛肋 / 其他
  海鮮 → 魚 / 蝦 / 蟹 / 貝 / 其他
```

**Step 1：規則引擎打標（零成本，覆蓋 ~80%）**
```python
TAG_RULES = {
    "牛": {
        "keywords": ["牛", "beef", "wagyu", "和牛", "安格斯"],
        "sub_tags": {
            "西冷": ["西冷", "sirloin", "striploin"],
            "肉眼": ["肉眼", "ribeye", "rib eye"],
            "牛柳": ["牛柳", "tenderloin", "filet"],
            "牛仔骨": ["牛仔骨", "short rib"],
        }
    },
    "豬": {
        "keywords": ["豬", "pork"],
        "sub_tags": {
            "豬扒": ["豬扒", "pork chop"],
            "豬腩": ["豬腩", "belly"],
            "排骨": ["排骨", "spare rib"],
        }
    },
    # ...
}
```

**Step 2：AI 兜底（處理規則匹配不到的 ~20%）**
- 商品名含有中英日混雜、長尾品類（如「法式鹿肉香腸」）
- 成本：~$0.5-1（只處理 300-600 個商品）

**標籤更新策略（DA 審查修訂）：**
- 標籤不是「打一次永久複用」
- 當 Monitor 發現商品名稱變更時，重新觸發打標
- 首次建庫後人工抽查 20% 標籤準確率，低於 90% 則調整規則/prompt

### 每日更新策略

```
每日凌晨自動執行：
  1. 重爬分類頁，拿到最新商品列表
  2. 比對現有庫：
     - 新出現的 URL → 新品：爬詳情 + 規則打標（失敗則 AI）
     - 已有的 URL   → 更新價格 + 檢查名稱變更（變更則重打標）
     - 消失的 URL   → 標記 last_seen_at（連續 3 天未出現才標記下架）
  3. 有新品 → 標記 needs_matching = true（Matcher 定時掃描處理）
```

每日更新只處理差異，成本極低。

### 運作模式

- **首次**：手動觸發建庫，確認數據質量
- **之後**：每日自動全庫更新

---

## 二、Matcher（智能匹配）

### 三層匹配關係

```
Level 1: DIRECT（直接替代品）
  同一種切割/品種，消費者會直接比價
  例：「A5 和牛西冷 250g」vs「和牛西冷 200g」
  用途：盯價格戰，對手降價要即時知道

Level 2: SIMILAR（近似競品）
  同切割不同等級/產地，消費者會考慮替代
  例：「A5 和牛西冷」vs「澳洲安格斯西冷」
  用途：看定價空間，你比對手貴多少合理

Level 3: CATEGORY（品類競品）
  同大類的其他選擇
  例：「和牛西冷」vs「牛仔骨」「牛柳」
  用途：看品類競爭格局，消費者的替代選擇
```

### AI 判斷信號

```
Level 1 信號：同切割 + 同品種（不論產地/等級）
  「A5和牛西冷」vs「和牛西冷」→ Level 1

Level 2 信號：同切割 + 不同品種/產地
  「A5和牛西冷」vs「澳洲安格斯西冷」→ Level 2

Level 3 信號：同大類 + 不同切割
  「A5和牛西冷」vs「牛仔骨」→ Level 3

無關：不同大類
  「A5和牛西冷」vs「三文魚刺身」→ 無關
```

### 匹配流程：規則預篩 + AI 精判

```
Step 1: 規則預篩（用標籤過濾）
  我的商品標籤 vs 競品標籤
  ├── 同細分標籤（都是「西冷」）→ 送 AI 判 Level 1 or 2
  └── 同大類標籤（都是「牛」）  → 送 AI 判 Level 3 or 無關

  效果：50 × 2,000 = 100,000 對 → 篩到每個商品 ~30-50 候選

Step 2: AI 精判（批量）
  每次送 20 個候選，AI 返回每個候選的：
  - match_level: 1 / 2 / 3 / null
  - confidence: 0.0 ~ 1.0
  - reason: 匹配理由

Step 3: 存入 DB
  寫入 product_competitor_mapping + match_level
```

### 觸發場景

```
場景 A：首次建庫完成 → 全局匹配
  50 × 2,000 競品，預篩後 ~150-250 次 AI 調用
  成本 ~$5-8

場景 B：我上新品 → 新品 vs 全競品庫
  1 × 2,000，預篩後 ~3-5 次 AI 調用
  成本 ~$0.1

場景 C：對手上新品 → 全我的商品 vs 新品
  50 × 1，預篩後 ~2 次 AI 調用
  成本 ~$0.05

注意：Matcher 不是即時觸發，而是定時掃描 needs_matching 標記（DA 審查修訂）
```

---

## 三、Monitor（每日監測）

### 監測流程

```
每日凌晨：
  Cataloger 更新競品庫
    ├── 價格變動 → 記錄 price_snapshots 歷史
    ├── 發現新品 → 規則/AI 打標 → 標記 needs_matching
    └── 商品消失 → 標記 last_seen_at（連續 3 天 → is_active = false）
```

### 異動推送（後續實現）

```
高優先級：Level 1 直接對手降價 > 10%
中優先級：Level 2 近似競品大幅調價
資訊通知：對手新品上架且與你直接競爭
```

---

## 數據模型變更

### competitor_products 表 — 新增標籤字段

```
competitor_products
  ├── ... (現有字段不變)
  ├── category_tag      ← 新增：大類標籤（牛/豬/魚/蝦...）
  └── sub_tag           ← 新增：細分標籤（西冷/肉眼/牛柳...）
```

### product_competitor_mapping 表 — 新增層級字段

```
product_competitor_mapping
  ├── product_id            （我的商品）
  ├── competitor_product_id （對手商品）
  ├── match_level           ← 新增：1 / 2 / 3
  ├── match_confidence      （已有，AI 信心度）
  ├── match_reason          （已有，AI 匹配理由）
  └── is_active             （已有）
```

### products 表 — 我的商品也打標籤

```
products
  ├── ... (現有字段不變)
  ├── category_tag      ← 新增：大類標籤
  └── sub_tag           ← 新增：細分標籤
```

---

## 成本估算（修訂版，基於實際數據）

| 項目 | 首次 | 每日 | 每月 |
|------|------|------|------|
| 建庫爬取 | 免費（API/HTTP） | 免費 | 免費 |
| 規則打標 | 免費（覆蓋 ~80%） | 免費 | 免費 |
| AI 打標（長尾 20%） | ~$1（~400 商品） | ~$0.05（新品） | ~$1.5 |
| AI 匹配 | ~$5-8（全局） | ~$0.2（增量） | ~$6 |
| **合計** | **~$6-9** | **<$0.3** | **<$8** |

---

## 代碼架構（目標）

```
backend/app/services/
  ├── cataloger.py       # 建庫：HKTVmall Algolia 拉取 + 惠康分類爬取
  ├── tagger.py          # 打標：規則引擎 + AI 兜底
  ├── matcher.py         # 匹配：預篩 + AI 精判 Level 1/2/3
  └── monitor.py         # 監測：每日差異更新 + 異動檢測
```

> DA 審查修訂：原設計 3 目錄 7 文件過度拆分。
> 改為 4 個扁平文件，每個文件一個清晰職責。
> 1-2 人團隊不需要目錄層級，文件級分離已足夠。

取代現有的：
- `competitor_matcher.py`（600+ 行，職責混雜）
- `wellcome_strategy.py`（搜索 + 爬取 + 匹配混在一起）

### 設計原則

- **一個模塊一個職責** — Cataloger 不知道匹配邏輯，Matcher 不知道怎麼爬
- **平台差異封裝在 Cataloger 內** — Matcher 只看標籤和商品名，不管數據從哪來
- **增量為主** — 只有首次是全量，之後都是差異處理

---

## 實施順序

```
Phase 1: 數據模型
  - Alembic migration: 加 category_tag, sub_tag, match_level
  - 不影響現有功能

Phase 2: Cataloger
  - hktvmall_catalog.py: 用 Algolia API 按分類拉取
  - wellcome_catalog.py: Playwright 分類頁 + JSON-LD
  - 手動觸發建庫 API endpoint

Phase 3: 標籤引擎
  - tagger.py: 規則引擎 + AI 兜底
  - 建庫完成後自動觸發打標

Phase 4: Matcher
  - matcher.py: 預篩 + AI 精判 Level 1/2/3 + 存 DB
  - 替換現有 competitor_matcher.py

Phase 5: Monitor
  - monitor.py: 差異更新邏輯 + needs_matching 掃描
  - Celery Beat 排程

Phase 6: 前端
  - 競品總覽頁：庫狀態 + 匹配覆蓋率
  - 商品詳情：三層競品列表 + 價格定位圖
```

---

## Dashboard 呈現（目標）

```
競品總覽頁：
  ┌─────────────────────────────────────────────┐
  │ 競品庫：HKTVmall 320 個 | 惠康 180 個        │
  │ 最後更新：今日 03:00                          │
  │ 匹配覆蓋：48/50 商品已有競品關係              │
  ├─────────────────────────────────────────────┤
  │ 我的商品        Level 1  Level 2  Level 3   │
  │ A5和牛西冷        2        5        12      │
  │ 北海道豬腩         1        3        8       │
  │ ...                                         │
  ├─────────────────────────────────────────────┤
  │ 點進單個商品 →                                │
  │                                              │
  │  Level 1 直接對手：                           │
  │   [和牛西冷 $280] [日本西冷 $320]             │
  │                                              │
  │  Level 2 近似競品：                           │
  │   [澳洲西冷 $89] [美國西冷 $75]              │
  │                                              │
  │  Level 3 品類競品：                           │
  │   [牛仔骨 $65] [牛柳 $120] ...               │
  │                                              │
  │  📊 價格定位圖：你在這個品類排第幾？           │
  └─────────────────────────────────────────────┘
```

---

## Devil's Advocate 審查摘要

> 2026-02-13 DA 審查完成，以下修訂已納入設計：

### 已採納的修訂

1. **商品數量修正** — 從「幾百個」修正為「1,500-3,000 個」（基於 Algolia 實測）
2. **標籤引擎改為混合模式** — 規則引擎處理 80% + AI 兜底 20%（原方案全 AI）
3. **下架判定軟化** — 連續 3 天未出現才標記下架（原方案 URL 消失即下架）
4. **觸發機制解耦** — Cataloger 只標記 `needs_matching`，Matcher 定時掃描（原方案即時觸發）
5. **文件結構簡化** — 4 個扁平文件取代 3 目錄 7 文件
6. **標籤更新策略** — 商品名稱變更時重打標（原方案「只打一次永久複用」）
7. **成本估算修正** — 首次 $6-9 / 月 <$8（原方案 $3 / <$5）

### 已知風險（接受但留意）

- Algolia API Key 可能被輪換 → 需要 Category API 降級路線
- 惠康 PoW CAPTCHA 可能在批量爬取時觸發 → 分批 + backoff
- 三層匹配的形態/規格歧義 → 在 AI prompt 中明確處理
- 跨平台同商品重複 → Dashboard 層面去重展示

### 留作 V2 的方向

- Embedding 向量搜索替代規則預篩（如 precision/recall 不理想）
- pgvector 支持語義相似度搜索
