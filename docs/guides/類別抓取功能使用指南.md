# 類別抓取功能使用指南

## 功能概覽

類別抓取功能讓你可以批量抓取 HKTVmall 整個類別的商品數據，並使用 AI 進行市場分析。

---

## 快速開始

### 1. 運行數據庫遷移

首次使用前需要創建數據表：

```bash
cd backend
# 如果使用 Docker
docker-compose exec backend alembic upgrade head

# 如果本地運行
alembic upgrade head
```

---

### 2. 創建類別數據庫

**POST** `/api/v1/categories`

```json
{
  "name": "和牛類",
  "description": "日本和牛商品數據庫",
  "hktv_category_url": "https://www.hktvmall.com/hktv/zh/main/search?q=%3Arelevance%3Acategory%3AA0020301",
  "scrape_frequency": "weekly"
}
```

響應：
```json
{
  "id": "uuid",
  "name": "和牛類",
  "total_products": 0,
  "is_active": true,
  "created_at": "2026-01-06T10:00:00Z"
}
```

---

### 3. 觸發類別抓取

**POST** `/api/v1/categories/{category_id}/scrape`

```json
{
  "category_id": "uuid",
  "max_products": 100
}
```

響應：
```json
{
  "task_id": "celery-task-id",
  "message": "已啟動類別 '和牛類' 的抓取任務",
  "category_name": "和牛類"
}
```

---

### 4. 查看抓取進度

**GET** `/api/v1/categories/{category_id}`

```json
{
  "id": "uuid",
  "name": "和牛類",
  "total_products": 87,
  "last_scraped_at": "2026-01-06T10:05:00Z",
  "is_active": true
}
```

---

### 5. 查看商品列表

**GET** `/api/v1/categories/{category_id}/products?page=1&page_size=20`

響應：
```json
{
  "items": [
    {
      "id": "uuid",
      "name": "日本 A5 和牛西冷 500g",
      "brand": "日本直送",
      "price": 1280.00,
      "original_price": 1580.00,
      "discount_percent": 19.00,
      "unit_price": 256.00,
      "unit_type": "per_100g",
      "stock_status": "in_stock",
      "is_available": true,
      "rating": 4.8,
      "review_count": 23,
      "image_url": "https://..."
    }
  ],
  "total": 87,
  "page": 1,
  "page_size": 20
}
```

---

### 6. 查看統計數據

**GET** `/api/v1/categories/{category_id}/stats`

響應：
```json
{
  "category_id": "uuid",
  "category_name": "和牛類",
  "total_products": 87,
  "available_products": 82,
  "avg_price": 985.50,
  "min_price": 380.00,
  "max_price": 2680.00,
  "price_range": 2300.00,
  "brands_count": 12,
  "last_scraped_at": "2026-01-06T10:05:00Z"
}
```

---

## AI 分析功能

### 7. 觸發數據摘要分析

**POST** `/api/v1/categories/{category_id}/analyze`

```json
{
  "category_id": "uuid",
  "analysis_type": "summary",
  "model": "claude-sonnet-4-20250514"
}
```

響應：
```json
{
  "task_id": "celery-task-id",
  "message": "已啟動數據摘要分析任務",
  "analysis_type": "summary"
}
```

---

### 8. 觸發趨勢預測分析

**POST** `/api/v1/categories/{category_id}/analyze`

```json
{
  "category_id": "uuid",
  "analysis_type": "trend",
  "model": "claude-sonnet-4-20250514"
}
```

---

### 9. 查看 AI 分析報告

**GET** `/api/v1/categories/{category_id}/reports?limit=5`

響應：
```json
[
  {
    "id": "uuid",
    "category_id": "uuid",
    "report_type": "summary",
    "report_title": "和牛類 - 數據摘要",
    "summary": "這個類別共有 87 個商品，平均價格 HK$985.50...",
    "key_findings": {
      "item_1": {
        "title": "價格區間廣泛",
        "description": "從 HK$380 到 HK$2,680，適合不同消費層級"
      },
      "item_2": {
        "title": "日本直送品牌佔主導",
        "description": "超過 60% 的商品來自日本直送品牌"
      }
    },
    "recommendations": {
      "item_1": {
        "title": "針對中端市場",
        "description": "HK$800-1,200 價格區間競爭最激烈，建議重點關注"
      }
    },
    "generated_by": "claude-sonnet-4-20250514",
    "generated_at": "2026-01-06T10:10:00Z"
  }
]
```

---

## API 完整列表

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/v1/categories` | GET | 獲取類別列表 |
| `/api/v1/categories` | POST | 創建類別 |
| `/api/v1/categories/{id}` | GET | 獲取類別詳情 |
| `/api/v1/categories/{id}` | PUT | 更新類別 |
| `/api/v1/categories/{id}` | DELETE | 刪除類別 |
| `/api/v1/categories/{id}/scrape` | POST | 觸發抓取 |
| `/api/v1/categories/{id}/products` | GET | 獲取商品列表 |
| `/api/v1/categories/{id}/stats` | GET | 獲取統計數據 |
| `/api/v1/categories/{id}/analyze` | POST | 觸發 AI 分析 |
| `/api/v1/categories/{id}/reports` | GET | 獲取分析報告 |

---

## 使用場景示例

### 場景 1：分析和牛市場價格

1. 創建「和牛類」類別數據庫
2. 觸發抓取（抓取所有和牛商品）
3. 查看統計：平均價格、價格區間、品牌分佈
4. 觸發「數據摘要」AI 分析
5. 根據 AI 建議調整定價策略

### 場景 2：監測冷凍肉類趨勢

1. 創建「冷凍肉類」類別數據庫
2. 設置每週自動抓取（`scrape_frequency: "weekly"`）
3. 每週查看 AI「趨勢預測」報告
4. 發現新興品牌或價格變化趨勢
5. 提前調整庫存和促銷策略

### 場景 3：多類別對比分析

1. 創建多個類別：和牛、安格斯牛、豬肉、雞肉
2. 同時抓取所有類別
3. 對比各類別的價格區間、品牌數量
4. 使用 AI 分析找出最具潛力的細分市場

---

## 注意事項

### 抓取頻率

- 建議每週抓取一次（避免過度消耗 Firecrawl API 額度）
- 每次抓取可能需要 5-30 分鐘（取決於商品數量）

### AI 分析

- 需要設置 `ANTHROPIC_API_KEY`
- 數據摘要：分析當前數據狀態
- 趨勢預測：需要多次抓取的歷史數據才能準確

### 成本控制

- Firecrawl: 每個商品 URL = 1 次抓取
- Claude AI: 每次分析約消耗 1,000-2,000 tokens

---

## 故障排查

### 抓取失敗

1. 檢查 `hktv_category_url` 是否正確
2. 確認 Firecrawl API Key 有效
3. 查看 Celery 日誌：`docker-compose logs -f celery`

### AI 分析失敗

1. 確認 `ANTHROPIC_API_KEY` 已設置
2. 檢查類別是否有足夠商品數據（至少 10 個）
3. 查看 Celery 日誌

---

## 下一步

- 前端界面開發（類別管理、數據可視化）
- 自動定時抓取功能
- 價格變動警報
- 多類別對比圖表
