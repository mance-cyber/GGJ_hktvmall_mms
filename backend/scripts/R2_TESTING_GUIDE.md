# Cloudflare R2 æ¸¬è©¦æŒ‡å—

> å¿«é€Ÿæ¸¬è©¦ R2 å­˜å„²é…ç½®æ˜¯å¦æ­£ç¢º

---

## ğŸ“‹ å‰ç½®æº–å‚™

### 1ï¸âƒ£ å‰µå»º Cloudflare R2 Bucket

1. ç™»å…¥ [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. é¸æ“‡ **R2 Object Storage**
3. é»æ“Š **Create Bucket**
4. è¼¸å…¥ Bucket åç¨±ï¼ˆä¾‹å¦‚ï¼š`gogojap-images`ï¼‰
5. é»æ“Š **Create Bucket**

---

### 2ï¸âƒ£ ç²å– R2 API Token

1. åœ¨ R2 é é¢ï¼Œé»æ“Š **Manage R2 API Tokens**
2. é»æ“Š **Create API Token**
3. é…ç½®æ¬Šé™ï¼š
   - **Permissions**: `Object Read & Write`
   - **Specify bucket(s)**: é¸æ“‡ä½ å‰µå»ºçš„ Bucket
4. é»æ“Š **Create API Token**
5. **ä¿å­˜** Access Key ID å’Œ Secret Access Key

âš ï¸ **é‡è¦**ï¼šSecret Access Key åªé¡¯ç¤ºä¸€æ¬¡ï¼Œè«‹å¦¥å–„ä¿å­˜ï¼

---

### 3ï¸âƒ£ ç²å– R2 Endpoint URL

åœ¨ R2 Bucket è©³æƒ…é é¢ï¼Œæ‰¾åˆ°ï¼š
- **S3 API Endpoint**: `https://<account-id>.r2.cloudflarestorage.com`

è¤‡è£½é€™å€‹ URL ä½œç‚º `R2_ENDPOINT`

---

### 4ï¸âƒ£ é…ç½® .env æ–‡ä»¶

ç·¨è¼¯ `backend/.env`ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```bash
# =============================================
# Cloudflare R2 å­˜å„²
# =============================================

# å•Ÿç”¨ R2 å­˜å„²
USE_R2_STORAGE=true

# R2 API æ†‘è­‰ï¼ˆå¾æ­¥é©Ÿ 2 ç²å–ï¼‰
R2_ACCESS_KEY=your-access-key-id-here
R2_SECRET_KEY=your-secret-access-key-here

# R2 Bucket åç¨±ï¼ˆå¾æ­¥é©Ÿ 1 ç²å–ï¼‰
R2_BUCKET=gogojap-images

# R2 Endpointï¼ˆå¾æ­¥é©Ÿ 3 ç²å–ï¼‰
R2_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com

# R2 å…¬é–‹ URLï¼ˆå¯é¸ï¼Œç¨å¾Œé…ç½®è‡ªå®šç¾©åŸŸåï¼‰
R2_PUBLIC_URL=https://your-account-id.r2.cloudflarestorage.com/gogojap-images
```

---

## ğŸ§ª é‹è¡Œæ¸¬è©¦

### æ–¹æ³• 1ï¼šç›´æ¥é‹è¡Œæ¸¬è©¦è…³æœ¬

```bash
cd backend
python scripts/test_r2_connection.py
```

### æ–¹æ³• 2ï¼šä½¿ç”¨è™›æ“¬ç’°å¢ƒ

```bash
cd backend
source venv/bin/activate  # Windows: venv\Scripts\activate
python scripts/test_r2_connection.py
```

---

## âœ… æ¸¬è©¦é …ç›®

æ¸¬è©¦è…³æœ¬æœƒè‡ªå‹•åŸ·è¡Œä»¥ä¸‹æª¢æŸ¥ï¼š

| æ­¥é©Ÿ | æ¸¬è©¦é …ç›® | èªªæ˜ |
|------|---------|------|
| 1 | æª¢æŸ¥é…ç½® | é©—è­‰æ‰€æœ‰å¿…éœ€çš„ç’°å¢ƒè®Šæ•¸ |
| 2 | åˆå§‹åŒ– StorageService | æ¸¬è©¦æœå‹™åˆå§‹åŒ– |
| 3 | æ¸¬è©¦ R2 é€£æ¥ | é©—è­‰ Bucket æ˜¯å¦å¯è¨ªå• |
| 4 | å‰µå»ºæ¸¬è©¦æ–‡ä»¶ | ç”Ÿæˆæ¸¬è©¦æ•¸æ“š |
| 5 | ä¸Šå‚³æ¸¬è©¦ | æ¸¬è©¦æ–‡ä»¶ä¸Šå‚³åŠŸèƒ½ |
| 6 | åˆ—å‡ºæ–‡ä»¶ | é©—è­‰æ–‡ä»¶åˆ—è¡¨åŠŸèƒ½ |
| 7 | é©—è­‰æ–‡ä»¶å­˜åœ¨ | æª¢æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸Šå‚³ |
| 8 | ä¸‹è¼‰é©—è­‰ | é©—è­‰ä¸‹è¼‰å…§å®¹ä¸€è‡´æ€§ |
| 9 | å…¬é–‹ URL | ç”Ÿæˆå…¬é–‹è¨ªå• URL |
| 10 | æ¸…ç†æ¸¬è©¦ | å¯é¸åˆªé™¤æ¸¬è©¦æ–‡ä»¶ |

---

## ğŸ“Š æˆåŠŸè¼¸å‡ºç¤ºä¾‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘               Cloudflare R2 é€£æ¥æ¸¬è©¦                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

============================================================
  Step 1: æª¢æŸ¥é…ç½®
============================================================
âœ“ USE_R2_STORAGE: True
âœ“ R2_BUCKET: gogojap-images
âœ“ R2_ENDPOINT: https://abc123.r2.cloudflarestorage.com
âœ“ R2_PUBLIC_URL: https://abc123.r2.cloudflarestorage.com/gogojap-images
âœ“ R2_ACCESS_KEY: 1234567890...
âœ“ R2_SECRET_KEY: abcdefghij...

============================================================
  Step 2: åˆå§‹åŒ– StorageService
============================================================
âœ“ StorageService åˆå§‹åŒ–æˆåŠŸ
âœ“ ä½¿ç”¨æ¨¡å¼ï¼šR2 å­˜å„²
âœ“ Bucketï¼šgogojap-images

============================================================
  Step 3: æ¸¬è©¦ R2 é€£æ¥
============================================================
âœ“ æˆåŠŸé€£æ¥åˆ° R2 Bucketï¼šgogojap-images

... (å…¶ä»–æ¸¬è©¦æ­¥é©Ÿ)

============================================================
  âœ… R2 é€£æ¥æ¸¬è©¦å®Œæˆ
============================================================

æ¸¬è©¦çµæœï¼š
  âœ“ R2 é€£æ¥æ­£å¸¸
  âœ“ æ–‡ä»¶ä¸Šå‚³æˆåŠŸ
  âœ“ æ–‡ä»¶åˆ—è¡¨æˆåŠŸ
  âœ“ æ–‡ä»¶å­˜åœ¨é©—è­‰æˆåŠŸ
  âœ“ æ–‡ä»¶ä¸‹è¼‰é©—è­‰æˆåŠŸ
  âœ“ å…¬é–‹ URL ç”ŸæˆæˆåŠŸ

ä¸‹ä¸€æ­¥ï¼š
  1. ä½ å¯ä»¥é–‹å§‹ä½¿ç”¨åœ–ç‰‡ç”Ÿæˆç³»çµ±
  2. æ‰€æœ‰ä¸Šå‚³çš„åœ–ç‰‡å°‡è‡ªå‹•å­˜å„²åˆ° R2
  3. ç¢ºä¿å‰ç«¯å¯ä»¥è¨ªå• R2_PUBLIC_URL

============================================================
æ¸¬è©¦å®Œæˆï¼R2 é…ç½®æ­£ç¢º ğŸ‰
============================================================
```

---

## âŒ å¸¸è¦‹éŒ¯èª¤

### éŒ¯èª¤ 1: `USE_R2_STORAGE=false`

```
âŒ éŒ¯èª¤ï¼šUSE_R2_STORAGE=false
   è«‹åœ¨ .env ä¸­è¨­ç½®ï¼šUSE_R2_STORAGE=true
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# backend/.env
USE_R2_STORAGE=true
```

---

### éŒ¯èª¤ 2: API æ†‘è­‰éŒ¯èª¤

```
âŒ é€£æ¥å¤±æ•—ï¼šThe AWS Access Key Id you provided does not exist in our records.
```

**å¯èƒ½åŸå› **ï¼š
1. `R2_ACCESS_KEY` éŒ¯èª¤
2. `R2_SECRET_KEY` éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- é‡æ–°æª¢æŸ¥ Cloudflare Dashboard çš„ API Token
- ç¢ºä¿è¤‡è£½æ™‚æ²’æœ‰å¤šé¤˜çš„ç©ºæ ¼

---

### éŒ¯èª¤ 3: Bucket ä¸å­˜åœ¨

```
âŒ é€£æ¥å¤±æ•—ï¼šThe specified bucket does not exist
```

**å¯èƒ½åŸå› **ï¼š
1. `R2_BUCKET` åç¨±éŒ¯èª¤
2. Bucket å°šæœªå‰µå»º

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- æª¢æŸ¥ Bucket åç¨±æ˜¯å¦èˆ‡ Dashboard ä¸­ä¸€è‡´
- ç¢ºä¿ Bucket å·²å‰µå»º

---

### éŒ¯èª¤ 4: Endpoint URL éŒ¯èª¤

```
âŒ é€£æ¥å¤±æ•—ï¼šCould not connect to the endpoint URL
```

**å¯èƒ½åŸå› **ï¼š
1. `R2_ENDPOINT` URL æ ¼å¼éŒ¯èª¤
2. Account ID éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- ç¢ºä¿æ ¼å¼ç‚ºï¼š`https://<account-id>.r2.cloudflarestorage.com`
- ä¸è¦åŒ…å« Bucket åç¨±åœ¨ Endpoint ä¸­

---

### éŒ¯èª¤ 5: æ¬Šé™ä¸è¶³

```
âŒ ä¸Šå‚³å¤±æ•—ï¼šAccess Denied
```

**å¯èƒ½åŸå› **ï¼š
- API Token æ¬Šé™ä¸è¶³

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. é‡æ–°å‰µå»º API Token
2. ç¢ºä¿æ¬Šé™è¨­ç½®ç‚º `Object Read & Write`
3. ç¢ºä¿ Token ç¶å®šåˆ°æ­£ç¢ºçš„ Bucket

---

## ğŸ”§ é€²éšé…ç½®

### é…ç½®è‡ªå®šç¾©åŸŸåï¼ˆå¯é¸ï¼‰

1. åœ¨ Cloudflare Dashboardï¼Œé¸æ“‡ä½ çš„ R2 Bucket
2. é»æ“Š **Settings** â†’ **Public Access**
3. é…ç½®è‡ªå®šç¾©åŸŸåï¼ˆä¾‹å¦‚ï¼š`images.gogojap.com`ï¼‰
4. æ›´æ–° `.env`ï¼š
   ```bash
   R2_PUBLIC_URL=https://images.gogojap.com
   ```

---

### é…ç½®å…¬é–‹è¨ªå•ï¼ˆå¯é¸ï¼‰

å¦‚æœä½ å¸Œæœ›åœ–ç‰‡å¯ä»¥å…¬é–‹è¨ªå•ï¼š

1. åœ¨ Bucket Settings ä¸­å•Ÿç”¨ **Public Access**
2. æˆ–è€…é…ç½® Cloudflare Workers ä½œç‚ºåå‘ä»£ç†

âš ï¸ **æ³¨æ„**ï¼šå…¬é–‹ Bucket æœƒè®“æ‰€æœ‰äººéƒ½èƒ½è¨ªå•åœ–ç‰‡

---

## ğŸ“ éœ€è¦å¹«åŠ©ï¼Ÿ

å¦‚æœæ¸¬è©¦å¤±æ•—æˆ–æœ‰å…¶ä»–å•é¡Œï¼š

1. æª¢æŸ¥ä¸Šæ–¹çš„ã€Œå¸¸è¦‹éŒ¯èª¤ã€éƒ¨åˆ†
2. ç¢ºä¿æ‰€æœ‰ç’°å¢ƒè®Šæ•¸æ­£ç¢ºé…ç½®
3. æŸ¥çœ‹ Cloudflare R2 æ–‡æª”ï¼šhttps://developers.cloudflare.com/r2/

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ¸¬è©¦æˆåŠŸå¾Œï¼š

1. **é–‹ç™¼ç’°å¢ƒ**ï¼š
   ```bash
   # åˆ‡æ›å›æœ¬åœ°å­˜å„²ï¼ˆé–‹ç™¼æ™‚æ›´å¿«ï¼‰
   USE_R2_STORAGE=false
   ```

2. **ç”Ÿç”¢ç’°å¢ƒ**ï¼š
   ```bash
   # ä¿æŒ R2 å­˜å„²å•Ÿç”¨
   USE_R2_STORAGE=true
   ```

3. **å•Ÿå‹•æœå‹™**ï¼š
   ```bash
   # å¾Œç«¯
   uvicorn app.main:app --reload

   # Celery Worker
   celery -A app.tasks.celery_app worker --loglevel=info
   ```

4. **æ¸¬è©¦åœ–ç‰‡ç”Ÿæˆ**ï¼š
   - è¨ªå•å‰ç«¯ä¸Šå‚³é é¢
   - ä¸Šå‚³æ¸¬è©¦åœ–ç‰‡
   - ç”Ÿæˆåœ–ç‰‡å°‡è‡ªå‹•å­˜å„²åˆ° R2

---

**ç¥æ¸¬è©¦é †åˆ©ï¼** ğŸš€
