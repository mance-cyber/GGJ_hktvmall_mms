<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡åˆ¥æŠ“å–åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
        }
        .category-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .category-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background: #fafafa;
        }
        .category-card h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .category-card p {
            margin: 5px 0;
            font-size: 13px;
            color: #666;
        }
        .category-card button {
            margin-top: 10px;
            font-size: 12px;
            padding: 6px 12px;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—‚ï¸ é¡åˆ¥æŠ“å–åŠŸèƒ½æ¸¬è©¦</h1>

        <!-- å‰µå»ºé¡åˆ¥ -->
        <div class="section">
            <h2>1. å‰µå»ºé¡åˆ¥æ•¸æ“šåº«</h2>
            <div class="form-group">
                <label>é¡åˆ¥åç¨±</label>
                <input type="text" id="categoryName" placeholder="ä¾‹å¦‚ï¼šå’Œç‰›é¡" value="æ¸¬è©¦é¡åˆ¥">
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="categoryDesc" placeholder="é¡åˆ¥æè¿°ï¼ˆå¯é¸ï¼‰">é€™æ˜¯ä¸€å€‹æ¸¬è©¦é¡åˆ¥</textarea>
            </div>
            <div class="form-group">
                <label>HKTVmall é¡åˆ¥ URL</label>
                <input type="text" id="categoryUrl" placeholder="https://www.hktvmall.com/..." value="https://www.hktvmall.com/hktv/zh">
            </div>
            <button onclick="createCategory()">å‰µå»ºé¡åˆ¥</button>
            <div id="createResult" class="result" style="display:none;"></div>
        </div>

        <!-- é¡åˆ¥åˆ—è¡¨ -->
        <div class="section">
            <h2>2. é¡åˆ¥åˆ—è¡¨</h2>
            <button onclick="loadCategories()">åˆ·æ–°åˆ—è¡¨</button>
            <div id="categoryList" class="category-list"></div>
        </div>

        <!-- å•†å“åˆ—è¡¨ -->
        <div class="section">
            <h2>3. æŸ¥çœ‹å•†å“</h2>
            <div class="form-group">
                <label>é¡åˆ¥ ID</label>
                <input type="text" id="productCategoryId" placeholder="å¾ä¸Šæ–¹è¤‡è£½é¡åˆ¥ ID">
            </div>
            <button onclick="loadProducts()">æŸ¥çœ‹å•†å“</button>
            <div id="productResult" class="result" style="display:none;"></div>
        </div>

        <!-- AI åˆ†æ -->
        <div class="section">
            <h2>4. AI åˆ†æ</h2>
            <div class="form-group">
                <label>é¡åˆ¥ ID</label>
                <input type="text" id="analyzeCategoryId" placeholder="å¾ä¸Šæ–¹è¤‡è£½é¡åˆ¥ ID">
            </div>
            <div class="form-group">
                <label>åˆ†æé¡å‹</label>
                <select id="analysisType">
                    <option value="summary">æ•¸æ“šæ‘˜è¦</option>
                    <option value="trend">è¶¨å‹¢é æ¸¬</option>
                </select>
            </div>
            <button class="success" onclick="triggerAnalysis()">é–‹å§‹åˆ†æ</button>
            <button onclick="viewReports()">æŸ¥çœ‹å ±å‘Š</button>
            <div id="analysisResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        // å‰µå»ºé¡åˆ¥
        async function createCategory() {
            const name = document.getElementById('categoryName').value;
            const description = document.getElementById('categoryDesc').value;
            const url = document.getElementById('categoryUrl').value;

            try {
                const response = await fetch(`${API_BASE}/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description,
                        hktv_category_url: url,
                        scrape_frequency: 'weekly'
                    })
                });

                const data = await response.json();
                showResult('createResult', data);

                if (response.ok) {
                    alert(`é¡åˆ¥å‰µå»ºæˆåŠŸï¼ID: ${data.id}`);
                    loadCategories();
                }
            } catch (error) {
                showResult('createResult', { error: error.message });
            }
        }

        // åŠ è¼‰é¡åˆ¥åˆ—è¡¨
        async function loadCategories() {
            const container = document.getElementById('categoryList');
            container.innerHTML = '<p class="loading">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/categories`);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    container.innerHTML = data.items.map(cat => `
                        <div class="category-card">
                            <h3>${cat.name}</h3>
                            <p><strong>ID:</strong> ${cat.id}</p>
                            <p><strong>å•†å“æ•¸:</strong> ${cat.total_products}</p>
                            <p><strong>ç‹€æ…‹:</strong> ${cat.is_active ? 'å•Ÿç”¨' : 'åœç”¨'}</p>
                            <p><strong>æœ€å¾ŒæŠ“å–:</strong> ${cat.last_scraped_at || 'æœªæŠ“å–'}</p>
                            <button onclick="triggerScrape('${cat.id}', '${cat.name}')">è§¸ç™¼æŠ“å–</button>
                            <button onclick="viewStats('${cat.id}')">æŸ¥çœ‹çµ±è¨ˆ</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>æš«ç„¡é¡åˆ¥</p>';
                }
            } catch (error) {
                container.innerHTML = `<p style="color:red;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
            }
        }

        // è§¸ç™¼æŠ“å–
        async function triggerScrape(categoryId, categoryName) {
            if (!confirm(`ç¢ºå®šè¦æŠ“å–ã€Œ${categoryName}ã€çš„å•†å“å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`${API_BASE}/categories/${categoryId}/scrape`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_id: categoryId, max_products: 50 })
                });

                const data = await response.json();
                alert(data.message || 'æŠ“å–ä»»å‹™å·²å•Ÿå‹•');
            } catch (error) {
                alert(`æŠ“å–å¤±æ•—: ${error.message}`);
            }
        }

        // æŸ¥çœ‹çµ±è¨ˆ
        async function viewStats(categoryId) {
            try {
                const response = await fetch(`${API_BASE}/categories/${categoryId}/stats`);
                const data = await response.json();

                alert(`çµ±è¨ˆæ•¸æ“š:\n\nç¸½å•†å“: ${data.total_products}\nå¯ç”¨å•†å“: ${data.available_products}\nå¹³å‡åƒ¹æ ¼: HK$${data.avg_price}\nåƒ¹æ ¼å€é–“: HK$${data.min_price} - HK$${data.max_price}\nå“ç‰Œæ•¸: ${data.brands_count}`);
            } catch (error) {
                alert(`è¼‰å…¥å¤±æ•—: ${error.message}`);
            }
        }

        // åŠ è¼‰å•†å“åˆ—è¡¨
        async function loadProducts() {
            const categoryId = document.getElementById('productCategoryId').value;
            if (!categoryId) {
                alert('è«‹è¼¸å…¥é¡åˆ¥ ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/categories/${categoryId}/products?page=1&page_size=20`);
                const data = await response.json();
                showResult('productResult', data);
            } catch (error) {
                showResult('productResult', { error: error.message });
            }
        }

        // è§¸ç™¼ AI åˆ†æ
        async function triggerAnalysis() {
            const categoryId = document.getElementById('analyzeCategoryId').value;
            const analysisType = document.getElementById('analysisType').value;

            if (!categoryId) {
                alert('è«‹è¼¸å…¥é¡åˆ¥ ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/categories/${categoryId}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category_id: categoryId,
                        analysis_type: analysisType,
                        model: 'claude-sonnet-4-20250514'
                    })
                });

                const data = await response.json();
                showResult('analysisResult', data);

                if (response.ok) {
                    alert('AI åˆ†æä»»å‹™å·²å•Ÿå‹•ï¼è«‹ç¨å¾ŒæŸ¥çœ‹å ±å‘Šã€‚');
                }
            } catch (error) {
                showResult('analysisResult', { error: error.message });
            }
        }

        // æŸ¥çœ‹å ±å‘Š
        async function viewReports() {
            const categoryId = document.getElementById('analyzeCategoryId').value;
            if (!categoryId) {
                alert('è«‹è¼¸å…¥é¡åˆ¥ ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/categories/${categoryId}/reports?limit=5`);
                const data = await response.json();
                showResult('analysisResult', data);
            } catch (error) {
                showResult('analysisResult', { error: error.message });
            }
        }

        // é¡¯ç¤ºçµæœ
        function showResult(elementId, data) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŠ è¼‰é¡åˆ¥åˆ—è¡¨
        window.onload = () => {
            loadCategories();
        };
    </script>
</body>
</html>
